version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:latest
    container_name: telegram-bot-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=support_bot
    networks:
      - telegram-bot-network

  # LocalStack for S3 Storage
  localstack:
    image: localstack/localstack:latest
    container_name: telegram-bot-localstack
    restart: unless-stopped
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/var/lib/localstack/data
      - DEFAULT_REGION=us-east-1
    volumes:
      - "./localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - telegram-bot-network

  # Telegram Bot Application
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telegram-bot-app
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_started
      localstack:
        condition: service_healthy
    ports:
      - "3000:3000"
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
    environment:
      # Bot Configuration
      - BOT_TOKEN=${BOT_TOKEN}
      - MONGODB_URI=${MONGODB_URI}
      - OWNER_ID=${OWNER_ID}
      - TECHNICIAN_IDS=${TECHNICIAN_IDS}
      
      # Web App Configuration
      - WEBAPP_URL=${WEBAPP_URL}
      - WEBAPP_PORT=3000
      
      # S3 Configuration
      - S3_ENDPOINT=http://localstack:4566
      - S3_PUBLIC_ENDPOINT=http://localhost:4566
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      
      # Node Environment
      - NODE_ENV=production
    networks:
      - telegram-bot-network

volumes:
  mongodb_data:
    driver: local

networks:
  telegram-bot-network:
    driver: bridge